<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>C</title>
  <meta http-equiv="content-type"
 content="text/html; charset=ISO-8859-1">
</head>
<body>
<pre>import slb.iop.*;<br><br>public class Client{<br><br><br>	static public void main(String args[]){<br><br>	boolean connected = false;<br>	boolean result = false;<br>	int CLA,INS,P1,P2,LE;<br>	int body[]=null;<br>	short out[]=null;<br>	<br>	<br>		IOP sIOP=new IOP();<br>		String[] listReaders=sIOP.ListReaders();<br>			System.out.println(listReaders.length);			<br>		for (int i=0;i&lt;listReaders.length;i++){		<br>			System.out.println(listReaders[i]);	<br>		}<br>		RCMIop rcml=new RCMIop();<br>		sIOP.addIOPListener(rcml);<br>		SmartCard maCard=new SmartCard();<br>		<br>		if (listReaders.length&gt; 0) {<br>			result = sIOP.Connect(maCard, listReaders[1], false);<br>			if (result) {<br>				System.out.println ("Carte connectee");<br>			}<br>		}<br>/* &eacute;tablissement de canal s&eacute;curis&eacute; pas indispensable */<br>/*		try {<br>			System.out.println ("Transaction EstablishSecureChannel");				<br>			maCard.BeginTransaction();<br>			short[] MACKey;<br>			short[] autKey;<br>			short[] KEKKey;<br>			MACKey = stringToShortArray("404142434445464748494A4B4C4D4E4F");<br>			autKey = stringToShortArray("404142434445464748494A4B4C4D4E4F");<br>			KEKKey = stringToShortArray("404142434445464748494A4B4C4D4E4F");<br>			connected = maCard.EstablishSecureChannel(MACKey, autKey, KEKKey);<br>			if (connected) {<br>				System.out.println ("Canal securise cree");<br>			}<br>			maCard.EndTransaction();<br>		}<br>		catch(slb.iop.slbException e){	System.out.println ("Pb d ouverture de canal");}<br>*/		<br>// selection de l'application OBLIGATOIRE (merci les trames de schlum !!)<br><br>		CLA = (int) Integer.parseInt("00", 16);<br>		INS = (int) Integer.parseInt("A4", 16);<br>		P1 = (int) Integer.parseInt("04", 16);<br>		P2 = (int) Integer.parseInt("00", 16);<br>    body=stringToIntArray("11223344556677");<br>		LE = (int) Integer.parseInt("00", 16);<br>		try {<br>			System.out.println ("Applet Selection");				<br>			maCard.BeginTransaction();<br>			maCard.SendCardAPDU(CLA,INS,P1,P2,body,LE);<br>			System.out.println ("Applet selected");<br>			maCard.EndTransaction();<br>		}<br>		catch(slb.iop.slbException e){	System.out.println ("Pb de Selection");}<br><br>		System.out.println ("Envoi de l'APDU VerifyPIN");<br>		CLA = (int) Integer.parseInt("80", 16);<br>		INS = (int) Integer.parseInt("40", 16);<br>		P1 = (int) Integer.parseInt("00", 16);<br>		P2 = (int) Integer.parseInt("00", 16);<br>    body=stringToIntArray("00000000");<br>		LE = (int) Integer.parseInt("00", 16);<br><br>		try {					<br>			maCard.BeginTransaction();<br>			maCard.SendCardAPDU(CLA,INS,P1,P2,body,LE);<br>			System.out.println ("Verify PIN ok");<br>			maCard.EndTransaction();<br>		}<br>		catch(slb.iop.slbException e){	System.out.println ("Pb de VerifyPIN");e.printStackTrace();}<br>			<br>		System.out.println ("Envoi de l'APDU getBalance");<br>		CLA = (int) Integer.parseInt("80", 16);<br>		INS = (int) Integer.parseInt("30", 16);<br>		P1 = (int) Integer.parseInt("00", 16);<br>		P2 = (int) Integer.parseInt("00", 16);<br>    body=stringToIntArray("");<br>		LE = (int) Integer.parseInt("01", 16);<br><br>		try {					<br>			maCard.BeginTransaction();<br>		out = maCard.SendCardAPDU(CLA,INS,P1,P2,body,LE);<br>			System.out.println ("getBalance ok"+out[0]);<br>			maCard.EndTransaction();<br>		}<br>		catch(slb.iop.slbException e){	System.out.println ("Pb de getBalance");e.printStackTrace();}<br><br>		System.out.println ("Envoi de l'APDU Deposit");<br>		CLA = (int) Integer.parseInt("80", 16);<br>		INS = (int) Integer.parseInt("10", 16);<br>		P1 = (int) Integer.parseInt("00", 16);<br>		P2 = (int) Integer.parseInt("00", 16);<br>    body=stringToIntArray("20");<br>		LE = (int) Integer.parseInt("00", 16);<br><br>		try {					<br>			maCard.BeginTransaction();<br>			maCard.SendCardAPDU(CLA,INS,P1,P2,body,LE);<br>			System.out.println ("Deposit ok");<br>			maCard.EndTransaction();<br>		}<br>		catch(slb.iop.slbException e){	System.out.println ("Pb de Deposit");e.printStackTrace();}<br>			<br>/*			<br>%				System.out.println ("Card connected");<br>%			else<br>%				System.out.println ("Can't connect Card");<br>%			return connected;<br>%		}<br>%		catch(slb.iop.slbException e) {<br>%			e.printStackTrace();<br>%			return false;<br>%		}<br>*/<br><br>	}<br>//outil stringToShortArray<br>	public static short[] stringToShortArray(String value) {<br>		short shortKey[] = new short[(value.length() / 2)];<br>		int y = 0;<br>		String strShort;<br><br>		for (int x = 0; x &lt; shortKey.length; x++) {<br>			strShort = value.substring(y, (y + 2));<br>			if (strShort.equals("FF")) {<br>				shortKey[x] = (short) 0xFF;<br>			} else {<br>				try {<br>					shortKey[x] = (short) Short.parseShort(strShort, 16);<br>				} catch (NumberFormatException e) {<br>					System.out.println("HexStringToShortArray Failed ");<br>				}<br>			}<br>			y = y + 2;<br>		}<br>		return shortKey;<br>	}<br>//outil stringToIntArray<br>	public static int[] stringToIntArray(String value) {<br>		int intKey[] = new int[(value.length() / 2)];<br>		int y = 0;<br>		String strInt;<br><br>		for (int x = 0; x &lt; intKey.length; x++) {<br>			strInt = value.substring(y, (y + 2));<br>			if (strInt.equals("FF")) {<br>				intKey[x] = (int) 0xFF;<br>			} else {<br>				try {<br>					intKey[x] = (int) Integer.parseInt(strInt, 16);<br>				} catch (NumberFormatException e) {<br>					System.out.println("stringToShortArray Failed ");<br>				}<br>			}<br><br>			y = y + 2;<br>		}<br>		return intKey;<br>	}<br>}</pre>
</body>
</html>
